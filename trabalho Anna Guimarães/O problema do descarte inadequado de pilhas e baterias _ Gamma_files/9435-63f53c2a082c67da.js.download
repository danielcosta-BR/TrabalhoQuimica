"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[9435],{62040:function(e,t,n){n.d(t,{n:function(){return i}});var o=n(62564),s=n(2784),r=n(14274),a=n(42111);let i=e=>{let t=(0,a.ye)("debugLogging");(0,s.useEffect)(()=>{if(e){if(t){console.debug("[Prosemirror DevTools] Activating prosemirror-dev-tools");try{(0,o.h)(e.view)}catch(e){}}else(0,o.P)();return r.v.DEBUG_ENABLED&&(window.openPMDT=()=>(0,o.h)(e.view)),()=>{(0,o.P)(),delete window.openPMDT}}},[e,t])}},27058:function(e,t,n){n.d(t,{F:function(){return a}});var o=n(72338),s=n(50125),r=n(88017);let a=o.hj.create({name:"animations",addOptions:()=>({}),addCommands:()=>({addAnimationPositions:(e,t)=>n=>{let{state:o,dispatch:s}=n;return s&&o.tr.setMeta(r.$,{type:"addAnimationPositions",isPresentMode:t,pos:e}),!0},enableAnimations:e=>t=>{let{state:n,dispatch:o}=t;return o&&n.tr.setMeta(r.$,{type:"enableAnimations",enabled:e}),!0},resetAnimationPositions:e=>t=>{let{state:n,dispatch:o}=t;return o&&n.tr.setMeta(r.$,{type:"resetAnimationPositions",isPresentMode:e}),!0}}),addProseMirrorPlugins:()=>[(0,s.Q2)()]})},50125:function(e,t,n){n.d(t,{iI:function(){return k},GD:function(){return D},l:function(){return P},VM:function(){return I},Q2:function(){return N},RN:function(){return E},PY:function(){return _}});var o=n(73200),s=n(72338),r=n(27191),a=n(52780),i=n(91994),l=n(47968),c=n(90604),d=n(91073),u=n(14657);let h=e=>"buttonGroup"===e.type.name;var p=n(57863),m=n(52332),g=n(15468),f=n(27835),y=n(26282),v=n(82400),S=n(59322),b=n(88017),w=n(38564),A=n(46795);let M=()=>({absPositions:[],relPositions:[]});class C{getPositions(e){return e?this.presentModePositions:this.editModePositions}apply(e,t){let n=e.getMeta(b.$);if(n)switch(n.type){case"addAnimationPositions":this.addAnimationPositions(n.pos,t,n.isPresentMode);break;case"resetAnimationPositions":this.resetAnimationPositions(n.isPresentMode);break;case"enableAnimations":this.enabled=n.enabled;break;default:console.warn("AnimationsState: unknown action type",n)}return this}addAnimationPositions(e,t,n){let o=this.getPositions(n);e.forEach(e=>{o.absPositions.push(e);let n=(0,A.jS)(t,e);n&&o.relPositions.push(n)})}resetAnimationPositions(e){e?this.presentModePositions=M():this.editModePositions=M()}getAnimationPositionsAbs(e,t){let n=w.Gt.getState(e),o=this.getPositions(t);return n?o.relPositions.map(t=>(0,A.XV)(e,t)).filter(Boolean):o.absPositions}constructor(){this.enabled=!0,this.presentModePositions=M(),this.editModePositions=M()}}let E="animate-has-animated",D="animatable-on-load",k="animatable-on-load-as-block",I="animatable-on-load-content-parent",P="animatable-on-load-content-child",T=e=>{switch(e.type.name){case"card":return!0===(0,m.HD)(e);case"cardAccentLayoutItem":return(0,g.pt)(e);case"calloutBox":case"gallery":case"smartLayout":case"divider":return!0;default:return(0,v.yV)(e)}},x=(e,t)=>(0,y.E)(e)||(0,f.u5)(t),_=(e,t)=>{let n=e.view.state.doc.resolve(t);if(!n)return;let o=e.state.doc.nodeAt(t);if(o&&T(o)&&!x(o,n)){let e=o.isLeaf||o.isAtom?0:-1;return{pos:n.pos+e,start:n.pos,depth:n.depth,node:o}}return(0,s.qv)(n,T)},R=(e,t)=>{let n=t.getAnimationPositionsAbs(e,(0,l.gh)((0,i.bh)().getState())===c.q.SLIDE_VIEW),o=n.reduce((e,t)=>Math.max(e,t),0),s=e.doc.nodeAt(o),r=s&&o>0?s.nodeSize:0;return o+r},N=()=>new r.Sy({key:b.$,state:{init:()=>new C,apply:(e,t,n,o)=>t.apply(e,o)},props:{decorations(e){let t=[],n=this.getState(e);if(!1===n.enabled)return a.EH.create(e.doc,t);let s=R(e,n);return e.doc.descendants((n,r,i,l)=>{let c=e.doc.resolve(r),m=T(n)||x(n,c);if(r<s&&m&&t.push(a.p.node(r,r+n.nodeSize,{class:E})),(0,y.G)(n)||(0,f.N5)(n))t.push(a.p.node(r,r+n.nodeSize,{class:I}));else if(h(n)||(0,p.m)(n)||(0,S.CU)(n))t.push(a.p.node(r,r+n.nodeSize,{class:k}));else if(x(n,c))t.push(a.p.node(r,r+n.nodeSize,{class:P,style:"--animate-index: ".concat(l+1)}));else if(T(n)){let e=!!i&&(0,u.R1)(n,i),s=n.isAtom;t.push(a.p.node(r,r+n.nodeSize,{class:(0,o.cx)(D,e&&"animatable-on-load-annotatable",s&&"animatable-on-load-atom")})),(0,g.pt)(n)&&t.push(a.p.node(r,r+n.nodeSize,{class:"animatable-on-load-accent"}))}let v=(0,d.KH)(n)&&c.depth>1;return!(v||(0,y.E)(n)||h(n)||(0,p.m)(n)||(0,S.CU)(n))}),a.EH.create(e.doc,t)}}})},88017:function(e,t,n){n.d(t,{$:function(){return s}});var o=n(27191);let s=new o.H$("animation")},16268:function(e,t,n){n.d(t,{R:function(){return i},p:function(){return l}});var o=n(72338),s=n(27191),r=n(69180);let a=new s.H$("yDocSize"),i=e=>{let t=a.getState(e.state);return t?t.getYDocSize():null},l=o.hj.create({name:"yDocSize",addProseMirrorPlugins(){let{document:e}=this.options;return[new s.Sy({key:a,state:{init:()=>new c(e),apply:(e,t)=>t}})]}});class c{getYDocSize(){return r.D$(this.ydoc).byteLength}constructor(e){this.ydoc=e}}},26900:function(e,t,n){n.d(t,{g:function(){return c},j:function(){return d}});var o=n(18149),s=n.n(o),r=n(2784),a=n(91994),i=n(47968),l=n(82400);let c=e=>{let t=(0,a.CG)(i.k8,function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return s()(...t)});return(0,r.useMemo)(()=>({enabled:!!(e&&t&&(0,l.Jg)(e,t)),pos:null==t?void 0:t.pos}),[e,t])},d=e=>{let t=(0,a.CG)(i.ks),n=(0,a.CG)(i.Vt,function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return s()(...t)});(0,r.useEffect)(()=>{if(!e||!t||!n)return;console.debug("[useScrollAndSpotlightSync] collaboratorBeingFollowed spotlight or scroll changed",JSON.stringify(n,null,2));let{spotlight:o,scroll:s}=n;e.commands.syncSpotlightAndScroll({spotlight:o,scroll:s,scrollOffset:100,isFollowing:!0})},[e,t,n])}},61750:function(e,t,n){n.d(t,{$1:function(){return o.$1},gZ:function(){return s.g},jB:function(){return s.j}});var o=n(82400),s=n(26900)},61811:function(e,t,n){n.d(t,{Ge:function(){return nc},yE:function(){return D.y},fb:function(){return nu.f},R$:function(){return nd.R$},bx:function(){return nd.bx},VK:function(){return nd.VK},vL:function(){return nd.vL}});var o=n(52780);o.tk.prototype.updateState=function(e){this.docView&&this.updateStateInner(e,this.state.plugins!=e.plugins)};var s=n(52322),r=n(73487),a=n(28535),i=n(42822),l=n(43297),c=n(81540),d=n(77533),u=n(79522),h=n(44058),p=n(64652),m=n(2784),g=n(91760),f=n(69180),y=n(14274),v=n(93202),S=n(42111),b=n(23405),w=n(25944),A=n(91994),M=n(29318),C=n(16268),E=n(36651),D=n(63669),k=n(72338),I=n(27191),P=n(41774),T=n(38322),x=n(96255);let _=()=>{let e=document.createElement("span");e.classList.add("collaboration-cursor__caret","streaming-cursor"),e.setAttribute("style","border-color: var(--chakra-colors-trueblue-100)");let t=document.createElement("div");return t.classList.add("collaboration-cursor__label","streaming-cursor__label"),t.setAttribute("style","background-color: var(--chakra-colors-trueblue-100); color: var(--chakra-colors-trueblue-400)"),e.insertBefore(t,null),e},R=k.hj.create({name:"aiGeneration",addOptions:()=>({provider:null}),addStorage:()=>({generationEnabled:!1}),onCreate(){let{provider:e}=this.options;e&&e.awareness&&e.awareness.on("change",()=>{if(!e.awareness)return;let t=!1;for(let[n,o]of e.awareness.getStates())o.isStreaming&&n!==e.awareness.clientID&&(t=!0);let n=(0,A.bh)(),o=(0,P.nl)(n.getState());o!==t&&n.dispatch((0,P.R4)(t))})},addCommands(){return{setAIGenerationRunning:e=>()=>{var t,n;return this.storage.generationEnabled=e,null===(n=this.options.provider)||void 0===n||null===(t=n.awareness)||void 0===t||t.setLocalStateField("isStreaming",e),!0}}},addProseMirrorPlugins(){let{storage:e}=this;return[new I.Sy({key:new I.H$("aiGeneration"),props:{decorations(t){if(!e.generationEnabled)return o.EH.empty;let n=[],s=t.doc.content.size-2,r=(0,k.qv)(t.doc.resolve(s),x.KH),a=r?(0,T.t)(t.doc.resolve(r.pos),-1):null;return a&&r&&(n.push(o.p.widget(a.from,_,{key:"sal",side:10})),n.push(o.p.node(r.pos,r.pos+r.node.nodeSize,{class:"ai-generate-streaming-card"}))),o.EH.create(t.doc,n)}}})]}});var N=n(8445);let O=()=>new I.Sy({key:N.i,state:{init:()=>new N.Y,apply:(e,t,n,o)=>t.apply(e,o)}}),j=k.hj.create({name:"aiModifications",onCreate(){this.options.document.on("afterAllTransactions",e=>{let t=N.i.getState(this.editor.view.state);t&&t.flushMoveInstructionQueue(this.editor.view.state)})},addProseMirrorPlugins:()=>[O()],addCommands:()=>({setInteractionRange:(e,t)=>n=>{let{tr:o}=n;return o.setMeta("aiModificationAction",{type:"setInteractionRange",rangeId:e,range:t}),!0}})});var z=n(47016),H=n(73200),B=n(11093);let L=(e,t)=>new I.Sy({props:{attributes:()=>t.salPanelOpen?{class:"sal-active"}:{class:""},decorations:n=>{let{doc:s,selection:r}=n;if(!t.salPanelOpen)return;let{from:a,to:i}=r,l=[],c=(0,B.Ru)(r.$from,x.KH);return c.forEach((e,t)=>{l.push(o.p.node(e.pos,e.pos+e.node.nodeSize,{class:(0,H.cx)(0==t?"sal-active-card":"sal-active-card-parent")}))}),(0,B.KB)(e)||(r instanceof I.Bs?l.push(o.p.inline(a,i,{class:(0,H.cx)("sal-selection-text")})):r instanceof I.qv&&l.push(o.p.node(a,i,{class:(0,H.cx)("sal-selection-node")}))),o.EH.create(s,l)}}}),U=k.hj.create({name:"salExtension",addStorage:()=>({salPanelOpen:!1}),addProseMirrorPlugins(){return[L(this.editor,this.storage)]},addCommands(){return{setSalOpen:e=>t=>{let{state:n,dispatch:o}=t;return this.storage.salPanelOpen=e,!0}}}});var V=n(27058),q=n(38564),F=n(54073),K=n.n(F),G=n(26151),$=n(6092);class J extends $.y{[Symbol.iterator](){return this.yarray[Symbol.iterator]()}values(){let e=this.yarray.length,t=-1;return{[Symbol.iterator]:()=>({next(){return++t===e?{value:void 0,done:!0}:{value:this.yarray.get(t),done:!1}}})}}forEach(e){return this.yarray.forEach(e)}set(e,t){return this.doc.transact(n=>{this.map.has(e)&&this.delete(e),this.yarray.push([{key:e,val:t}])}),t}delete(e){let t=0;for(let n of this.yarray){if(n.key===e){this.yarray.delete(t);break}t++}}get(e){let t=this.map.get(e);return t&&t.val}has(e){return this.map.has(e)}constructor(e){super(),this.yarray=e,this.doc=e.doc,this.map=new Map;let t=e.toArray();this.doc.transact(n=>{for(let n=t.length-1;n>=0;n--){let o=t[n];this.map.has(o.key)?e.delete(n):this.map.set(o.key,o)}}),e.observe(t=>{let n=new Map,o=Array.from(t.changes.added);t.changes.deleted.forEach(e=>{e.content.getContent().forEach(e=>{this.map.get(e.key)===e&&(this.map.delete(e.key),n.set(e.key,{action:"delete",oldValue:e.val}))})});let s=new Map;o.map(e=>e.content.getContent()).flat().forEach(e=>{s.set(e.key,e)});let r=new Set,a=e.toArray();this.doc.transact(t=>{for(let t=a.length-1;t>=0&&(s.size>0||r.size>0);t--){let o=a[t];if(r.has(o.key))r.delete(o.key),e.delete(t,1);else if(s.get(o.key)===o){let e=this.map.get(o.key);if(e)r.add(o.key),n.set(o.key,{action:"update",oldValue:e.val,newValue:o.val});else{let e=n.get(o.key);e&&"delete"===e.action?n.set(o.key,{action:"update",newValue:o.val,oldValue:e.oldValue}):n.set(o.key,{action:"add",newValue:o.val})}s.delete(o.key),this.map.set(o.key,o)}else s.has(o.key)&&(r.add(o.key),s.delete(o.key))}}),n.size>0&&this.emit("change",[n])})}}class Q{run(e){}}class Y extends Q{createKeyValue(e,t){let n=e.getArray(t),o=new J(n);return o}getRestoreMap(e){return e.getMap("annotationsAbsolute")}run(e){let t=this.createKeyValue(e,"annotationsAbsoluteKV"),n=this.getRestoreMap(e);for(let[e,o]of n.entries())t.set(e,o)}constructor(...e){super(...e),this.name="AnnotationsYKeyValue"}}class Z{runMigrations(){let e=this.getMigrationsMap();for(let t of this.migrations)if(!this.hasRunMigration(t.name))try{t.run(this.document),e.set(t.name,!0)}catch(e){}}getMigrationsMap(){return this.document.getMap(Z.ANNOTATION_MIGRATIONS_KEY)}hasRunMigration(e){return this.getMigrationsMap().get(e)||!1}constructor(e){this.migrations=[new Y],this.document=e,this.document.transact(()=>{this.runMigrations()}),this.annotations=this.document.getMap("annotations"),this.annotationsAbsolute=new J(this.document.getArray("annotationsAbsoluteKV"))}}Z.ANNOTATION_MIGRATIONS_KEY="annotationMigrations";class W{get id(){return this.decoration.type.spec.id}get from(){return this.decoration.from}get data(){return this.decoration.type.spec.data}get HTMLAttributes(){return this.decoration.type.attrs}toString(){return JSON.stringify({id:this.id,data:this.data,from:this.from,HTMLAttributes:this.HTMLAttributes})}constructor(e){this.decoration=e}}var X=n(50105),ee=n(36069),et=n(9850),en=n.n(et),eo=n(35838),es=n.n(eo),er=n(84636),ea=n.n(er),ei=n(46795),el=n(14657);function ec(e){let t=[];for(let n=e.length-1;n>=0;n--){let o=e[n];t.push({...o,prev:o.next,next:o.prev})}return t}class ed{flushUndoQueue(){let{undoQueue:e}=this;return this.undoQueue=[],e}set(e,t){let n=this.map.get(e);return this.undoQueue.unshift({type:"set",key:e,next:n,prev:t}),this.map.set(e,t)}delete(e){let t=this.map.get(e);return void 0===t||this.undoQueue.unshift({type:"set",key:e,next:t,prev:void 0}),this.map.delete(e)}constructor(e){this.map=e,this.undoQueue=[]}}class eu{persistRestoreMap(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n={deletion:0,relToAbs:0,setting:0,total:0},o=performance.now();(t||this.hasChanges)&&(this.transactYDoc(()=>{let t=performance.now();for(let{key:e}of this.restoreMap)this.restoreMap.delete(e);n.deletion=performance.now()-t,this.map.forEach(t=>{let{id:o,pos:s,data:r}=t;try{let t=performance.now(),a=this.relToAbs(e,s);n.relToAbs+=performance.now()-t;let i=performance.now();this.restoreMap.set(o,{id:o,data:r,absPos:a}),n.setting+=performance.now()-i}catch(e){console.error("[Annotations] persistRestoreMap error: ",e.message)}})}),n.total=performance.now()-o,this.log("[Annotations] persistRestoreMap in ".concat(n.total,"ms"),{values:this.restoreMap.yarray.toArray(),performance:n}),this.hasChanges=!1)}flushMoveInstructionQueue(){let{moveInstructionMap:e}=this;return this.moveInstructionMap={},Object.values(e)}clearCutData(){this.cutData=null,this.filmstripCutData=null}getAnnotationsBetween(e,t,n){let o=[];for(let s of this.map.values())try{let r=this.relToAbs(e,s.pos);if(null===r)continue;t<=r&&r<n&&o.push({id:s.id,data:s.data,pos:r,relativePos:s.pos})}catch(e){console.warn("[Annotations] getAnnotationsBetween error: ",e.message)}return o}apply(e,t){let n=q.Gt.getState(t);if(n.isChangeOrigin){try{this.createDecorations(t)}catch(e){console.warn("[Annotations] handle remote change, not create decorations: ".concat(e.message))}return this}let o=e.getMeta(X.Z);if(o){switch(o.type){case"addAnnotation":this.addAnnotation(o,t);break;case"restoreAnnotations":this.restoreAnnotations(o);break;case"clearAnnotations":this.clearAnnotations();break;case"deleteAnnotation":this.deleteAnnotation(o.id);break;case"refreshAnnotationDecorations":try{this.createDecorations(t)}catch(e){console.warn("could not create decorations: ".concat(e.message))}break;case"moveAnnotations":this.moveAnnotations(t,o.toMove)}return this.hasChanges=!0,this}let s=e.getMeta("uiEvent");switch(s){case"cut":this.handleCutTransaction(t,e);break;case"paste":this.handlePasteTransaction(t,e)}let r=e.getMeta("annotationEvent");switch(null==r?void 0:r.type){case"split-card":this.handleSplitCard(t,e,r);break;case"split-block":this.handleSplitBlock(t,e,r);break;case"join-forward":this.handleJoinForward(t,e,r);break;case"join-backward":this.handleJoinBackward(t,e,r);break;case"update-node-attrs":this.handleUpdateNodeAttrs(t,e,r);break;case"rearrange-cards":this.handleRearrangeCards(t,e,r);break;case"move":this.handleMove(t,e,r);break;case"merge-cards":this.handleMergeCards(t,e,r);break;case"drop":this.handleDropAnnotations(t,e,r);break;case"unwrap-node":this.handleUnwrapNode(t,e,r);break;case"wrap-nodes":this.handleWrapNodes(t,e,r);break;case"filmstrip-cut":this.handleFilmstripCut(t,e,r);break;case"filmstrip-paste":this.handleFilmstripPaste(t,e,r);break;default:e.getMeta("appendedTransaction")||(this.handleReplaceTransaction(t,e),this.handleReplaceAroundTransaction(t,e))}return e.docChanged&&(this.hasChanges=!0),this.handleLocalChange(e)}restore(e,t){t.forEach(t=>{let{next:n,key:o}=t;void 0===n?this.map.delete(o):this.map.set(o,{...n,pos:this.refreshRelativePos(e,n.pos)})}),this.persistRestoreMap(e,!0)}handleUnwrapNode(e,t,n){let{pos:o}=n,s=t.before.resolve(o),r=s.start(s.depth+1),a=t.before.resolve(r).end(),i=this.getAnnotationsBetween(e,r,a).map(t=>{let{id:n,relativePos:s}=t,a=this.relToAbs(e,s);if(null===a)return null;let i=a-r;return{id:n,newPos:o+i}}).filter(e=>!!e);this.log("%c[Annotations] unwrap node","color: green",{tr:t,pos:o,start:r,end:a,toMove:i}),i.length>0&&this.enqueueMoveInstructions(i)}handleWrapNodes(e,t,n){let{start:o,end:s,level:r}=n,a=this.getAnnotationsBetween(e,o,s).map(e=>{let{id:t,pos:n}=e;return{id:t,newPos:n+r}}).filter(e=>!!e);this.log("%c[Annotations] wrap nodes","color: green",{tr:t,start:o,end:s,toMove:a}),a.length>0&&this.enqueueMoveInstructions(a)}handleMergeCards(e,t,n){let{insertPos:o,contentPos:s}=n,r=t.before.nodeAt(s);if(!r){console.error("[AnnotationState] trying to merge cards, but cannot resolve content wrapper");return}let a=this.getAnnotationsBetween(e,s,s+r.nodeSize).map(e=>{let{id:t,pos:n}=e,r=n-s-1;return{id:t,newPos:o+r}});this.log("%c[Annotations] merge cards","color: green",{transaction:t,insertPos:o,contentPos:s,toMove:a}),a.length>0&&this.enqueueMoveInstructions(a)}handleRearrangeCards(e,t,n){let{rearrangedCardPositions:o,insertPos:s}=n,r=o.flatMap(n=>{let{newPos:o,oldPos:s}=n,r=t.before.resolve(s);return this.getAnnotationsBetween(e,s,s+r.nodeAfter.nodeSize).map(e=>{let{id:t,pos:n}=e;return{id:t,newPos:o+(n-s)}})}),a=[],i=(0,x.Y0)(t.before);if(i){let n=o[0].oldPos,r=Math.min(n,s),l=Math.max(n,s);a=i.flatMap(n=>{let{node:s,pos:a}=n,i=a>=r&&a<=l,c=i&&!o.find(e=>e.id===s.attrs.id);if(!c)return[];{let n=t.before.resolve(a),o=a+n.nodeAfter.nodeSize;return this.getAnnotationsBetween(e,a,o).map(e=>{let{id:n,pos:o}=e;return{id:n,newPos:t.mapping.map(o)}})}})}this.log("%c[Annotations] rearrange cards","color: green",{transaction:t,rearrangedCardPositions:o,annotationsInRearrangedCards:r,jumpedAnnotations:a});let l=[...r,...a];l.length>0&&this.enqueueMoveInstructions(l)}handleMove(e,t,n){let{insertPos:o,insertPosRaw:s,pos:r,end:a}=n,i=this.getAnnotationsBetween(e,r,a).map(e=>{let{id:t,pos:n}=e;return{id:t,newPos:o+(n-r)}}),l=this.getAnnotationsBetween(e,Math.min(s,a),Math.max(s,r)).map(e=>{let{id:n,pos:o}=e;return{id:n,newPos:t.mapping.map(o)}});this.log("%c[Annotations] move","color: green",{transaction:t,insertPos:o,insertPosRaw:s,pos:r,end:a,annotationsInCard:i,jumpedAnnotations:l});let c=[...i,...l];c.length>0&&this.enqueueMoveInstructions(c)}handleUpdateNodeAttrs(e,t,n){let{pos:o}=n,s=t.doc.nodeAt(o);if(!s)return;let r=this.getAnnotationsBetween(e,o,o+s.nodeSize).map(e=>{let{id:t,pos:n}=e;return{id:t,newPos:n}});this.log("%c[Annotations] update node attrs","color: green",{transaction:t,pos:o,toMove:r}),r.length>0&&this.enqueueMoveInstructions(r)}handleJoinBackward(e,t,n){let{atBeginning:o,joinPos:s}=n;if(!o)return;let r=t.before.resolve(s),a=t.before.resolve(r.before()),i=a.nodeBefore,l=a.nodeAfter;if(!i||!l)return;let c=a.pos+l.nodeSize,d=a.pos-i.nodeSize,u=e.selection.from;this.log("%c[Annotations] join backward","color: green",{transaction:t,prevBlock:i,nextBlock:l,nextBlockPos:a.pos,nextBlockEnd:c,prevBlockPos:d,joinPoint:u});let h=this.getAnnotationsBetween(e,a.pos,c);if(0===h.length){this.enqueueRefreshDecorations();return}0===l.content.size?(h.forEach(e=>{let{id:t}=e;return this.undoableMap.delete(t)}),requestAnimationFrame(()=>{this.writeUndoStack(e)})):this.enqueueMoveInstructions(h.map(e=>{let{id:t,pos:n}=e,o=Math.max(n-a.pos-1,0),s=0===i.content.size?d:u;return{id:t,newPos:s+o}}))}handleJoinForward(e,t,n){let{atEnd:o,joinPos:s}=n;if(!o)return;let r=t.before.resolve(s),{pos:a,node:i}=(0,B.nv)(r,e=>e.isBlock)[0],l=t.before.resolve(r.after()),c=l.nodeAfter;if(!c)return;let d=l.pos+c.nodeSize;this.log("%c[Annotations] join forward","color: green",{sel:e.selection,prevBlock:i,transaction:t,deleteAnnotations:!!c.isAtom,joinPos:r.pos,prevBlockPos:a,nextBlockPos:l.pos,nextBlock:c});let u=this.getAnnotationsBetween(e,a,a+i.nodeSize),h=this.getAnnotationsBetween(e,l.pos,d);if(0===h.length&&0===u.length){this.enqueueRefreshDecorations();return}let p=t=>{t.forEach(e=>{let{id:t}=e;return this.undoableMap.delete(t)}),requestAnimationFrame(()=>{this.writeUndoStack(e)})};c.isAtom&&i.content.size>0?p(h):0===i.content.size?p(u):this.enqueueMoveInstructions(h.map(e=>{let{id:t,pos:n}=e,o=Math.max(n-l.pos-1,0),r=0===i.content.size?a:s;return{id:t,newPos:r+o}}))}handleSplitBlock(e,t,n){let{splitPos:o,atBeginning:s}=n;if(s){this.enqueueRefreshDecorations();return}let r=t.before.resolve(o),{pos:a,node:i}=(0,B.nv)(r,e=>e.isBlock)[0],{$from:l}=e.selection,c=(0,B.nv)(l,e=>e.isBlock)[0],d=this.getAnnotationsBetween(e,o,a+i.nodeSize).map(e=>{let{id:t,pos:n}=e,s=n-o;return{id:t,newPos:c.pos+(0===s?s:s+1)}});d.length>0?this.enqueueMoveInstructions(d):this.enqueueRefreshDecorations(),this.log("%c[Annotations] split block","color: green",{sel:e.selection,transaction:t,splitPos:o,toMove:d,$before:r})}handleSplitCard(e,t,n){let{splitPos:o}=n,s=t.before.resolve(o),r=(0,B.nv)(s,x.KH)[0];if(!r)return;let a=r.pos,i=r.pos+r.node.nodeSize,l=this.getAnnotationsBetween(e,a,i).map(e=>{let{id:n,pos:s}=e;return{id:n,newPos:s===o?t.mapping.map(s+1)-1:t.mapping.map(s)}});this.log("%c[Annotations] split card","color: green",{transaction:t,splitPos:o,parentEnd:i,toMove:l}),this.enqueueMoveInstructions(l)}handlePasteTransaction(e,t){if(!this.cutData&&!this.filmstripCutData)return;let n=t.steps.find(e=>"replace"===e.jsonID);if(!n)return;let{from:o,to:s,slice:{openStart:r}}=n,a=e.doc.resolve(n.from),i=s===o?o:o+1,l=null==a.nodeBefore&&a.parent.isBlock,c=!r||l;if(this.log("%c[Annotations] paste transaction","color: green",{transaction:t,insertPos:o,resolved:a,isPasteBeginning:l,pasteType:this.cutData?"cut":"filmstrip-cut"}),this.cutData){let e=this.cutData;this.cutData=null;let t=e.toMove.map(e=>{let{id:t,offset:n}=e;return{id:t,newPos:i+(c?n:Math.max(0,n))}});t&&t.length>0&&(this.log("[Annotations] paste from cut final move",t),this.enqueueMoveInstructions(t))}else if(this.filmstripCutData){let n=this.filmstripCutData;this.filmstripCutData=null;let o=i-1;for(;o<e.doc.nodeSize;){let t=e.doc.nodeAt(o);if(t&&(0,x.KH)(t))break;o++}let s=this.getMoveInstructionsForFilmstripPaste(t,n,o);s&&s.length>0&&(this.log("[Annotations] paste from filmstrip cut final move",s),this.enqueueMoveInstructions(s))}}getMoveInstructionsForFilmstripPaste(e,t,n){if(!t)return;let o=(0,k.N2)(e.doc,x.KH);if(!o)return;let s=e.doc.resolve(n).depth,r=o.filter(t=>{let{pos:n}=t;return e.doc.resolve(n).depth===s}),a=r.findIndex(e=>e.pos===n);if(-1===a)return;let i=r.slice(a),l=t.flatMap(e=>{let{cardIndex:t,annotations:n}=e;return n.map(e=>{let{id:n,offset:o}=e,s=i[t];if(s)return{id:n,newPos:s.pos+o}}).filter(e=>!!e)});return l}handleFilmstripPaste(e,t,n){if(!this.cutData&&!this.filmstripCutData)return;let{insertPos:o}=n;if(this.cutData){let e=this.cutData;this.cutData=null;let n=e.toMove.map(e=>{let{id:t,offset:n}=e;return{id:t,newPos:o+n}});n&&n.length>0&&(this.log("[Annotations] filmstripPaste from cut final move",{tr:t,cutData:e,moveInstructions:n}),this.enqueueMoveInstructions(n))}else if(this.filmstripCutData){let e=this.filmstripCutData;this.filmstripCutData=null;let n=this.getMoveInstructionsForFilmstripPaste(t,e,o);n&&n.length>0&&(this.log("%c[Annotations] filmstripPaste from filmstrip cut final move","color: green",{tr:t,filmstripCutData:e,moveInstructions:n}),this.enqueueMoveInstructions(n))}}handleFilmstripCut(e,t,n){this.cutData=null,this.filmstripCutData=n.deleted.map(n=>{let{cardIndex:o,pos:s}=n,r=t.before.resolve(s),a=s+r.nodeAfter.nodeSize,i=this.getAnnotationsBetween(e,s,a).map(e=>{let{id:t,pos:n}=e;return{id:t,offset:n-s}});return{cardIndex:o,annotations:i}}),this.log("%c[Annotations] filmstripCut","color: green",{tr:t,filmstripCutData:this.filmstripCutData})}handleCutTransaction(e,t){let n=t.steps.find(e=>"replace"===e.jsonID);if(!n)return;this.filmstripCutData=null;let{from:o,to:s}=n,r=e.doc.resolve(o),a=null==r.nodeAfter&&null==r.nodeBefore&&r.parent.isBlock,i=this.getAnnotationsBetween(e,o-(a?1:0),s),l=i.map(t=>{let n=this.relToAbs(e,t.relativePos);return{id:t.id,offset:n-o}});this.cutData={slice:n.slice,toMove:l},this.log("%c[Annotations] cut transaction","color:green",{isWholeBlock:a,resolved:r,transaction:t,annotations:i,moveData:l})}handlePrependContentToBlock(e,t){let n=t.steps.find(e=>"replace"===e.jsonID);if(!n)return;let{from:o}=n,s=t.before.resolve(o);if(!s.nodeAfter)return;let r=this.getAnnotationsBetween(e,o,o+s.nodeAfter.nodeSize).map(n=>{let{id:s,relativePos:r}=n,a=this.relToAbs(e,r),i=a===o?t.mapping.map(a+1)-1:t.mapping.map(a);return{id:s,newPos:i}});r.length>0&&(this.log("%c[Annotations] replace transaction - prepend content","color:green",{tr:t,annotationsToMove:r}),this.enqueueMoveInstructions(r))}handleReplaceTransaction(e,t){let n=t.steps.find(e=>"replace"===e.jsonID);if(!n)return;let{from:o,to:s}=n,r=t.before.resolve(o),a=t.before.resolve(s),i=r.parent!==a.parent,l=0==n.slice.content.size,c=0===r.parentOffset&&s>=o+r.parent.nodeSize-2,d=c&&l,u=0===a.parentOffset&&a.depth===r.depth+1&&a.pos-r.pos==1;if(u)return this.handlePrependContentToBlock(e,t);let h=!1;if(i){var p;let n=d?[]:this.getAnnotationsBetween(e,o-r.parentOffset-1,o).map(t=>{let{id:n,relativePos:o}=t;return{id:n,newPos:this.relToAbs(e,o)}}),i=this.getAnnotationsBetween(e,s,s+(null===(p=a.nodeAfter)||void 0===p?void 0:p.nodeSize)+1).map(n=>{let{id:o,relativePos:s}=n;return{id:o,newPos:t.mapping.map(this.relToAbs(e,s))}}),l=[...n,...i];this.log("[Annotations] multiline to move",l),l.length>0&&(h=!0,this.enqueueMoveInstructions(l))}let m=this.getAnnotationsBetween(e,o-(d||i&&0===r.parentOffset?1:0),s);m.length>0&&(h=!0,this.log("[Annotations] to delete",m),m.forEach(e=>{this.undoableMap.delete(e.id)})),h&&(this.log("%c[Annotations] replace transaction","color:green",{tr:t,annotationsToDelete:m,isWholeBlock:d,isMultiline:i,replacingEntireFromBlock:c,replacingWithNothing:l}),requestAnimationFrame(()=>{this.writeUndoStack(e)}))}handleReplaceAroundTransaction(e,t){let n=es()(t.steps.filter(e=>"replaceAround"===e.jsonID),t=>{let{from:n,to:o}=t;return this.getAnnotationsBetween(e,n,o)}),o=ea()(n,e=>e.id).map(e=>{let{id:n,pos:o}=e;return{id:n,newPos:t.mapping.map(o)}});return o.length>0&&this.log("%c[Annotations] replaceAround transaction","color:green",{tr:t,moveInsturctions:o}),0!==o.length&&(this.enqueueMoveInstructions(o),!0)}clearAnnotations(){this.transactYDoc(()=>{this.map.forEach((e,t)=>{this.map.delete(t)})})}restoreAnnotations(e){this.log("%c[Annotations] restoreAnnotations","color: green",e);let{toRestore:t}=e;this.clearAnnotations(),this.enqueueMoveInstructions(t.filter(e=>{let{absPos:t}=e;return null!=t}).map(e=>{let{absPos:t,id:n}=e;return{id:n,newPos:t}}))}addAnnotation(e,t){this.log("%c[Annotations] addAnnotation","color: green",e);let{pos:n,id:o,data:s}=e,r=this.absToRel(t,n);this.map.set(o,{id:o,pos:r,data:s})}deleteAnnotation(e){this.log("%c[Annotations] deleteAnnotation","color: green",e),this.map.delete(e)}moveAnnotations(e,t){let{map:n}=this;this.log("%c[Annotations] moveAnnotations","color: green",t),this.transactYDoc(()=>{t.forEach(t=>{let{id:o,newPos:s}=t,r=n.get(o)||{id:o};this.undoableMap.set(o,{...r,pos:this.absToRel(e,s)})})}),this.writeUndoStack(e)}writeUndoStack(e){let t=q.Gk.getState(e).undoManager;if(0===t.undoStack.length)return;let n=this.undoableMap.flushUndoQueue();if(0===n.length)return;let o=t.undoStack[t.undoStack.length-1],s="annotations",r=o.meta.get(s)||[];r.length>0&&this.log("[Annotations] existing undo stack",{existing:r,toWrite:n,stack:t.undoStack});let a=[...n,...r];o.meta.set(s,a),this.log("[Annotations] writing to undo stack",a)}createDecorations(e){let{map:t}=this.options;this.refreshDecorations=!1;let n=[],s=[];t.forEach((t,r)=>{let a=(0,ei.XV)(e,t.pos);if(null==a)return;let i=e.doc.nodeAt(a);i&&((null==i?void 0:i.isInline)?n.push(o.p.inline(a,a+1,{class:"debug-comment-cursor"})):n.push(o.p.node(a,a+i.nodeSize,{class:"debug-comment-block"}))),s.push({id:r,data:t.data,relativePos:t.pos,pos:a})}),e.doc.descendants((e,t,r)=>{if(t>0&&!(0,el.ZM)(r)&&!(0,el.ZM)(e))return!1;let a=s.filter(n=>n.pos>=t&&n.pos<t+e.nodeSize);return a.forEach(s=>{let{id:r,data:a}=s;n.push(o.p.node(t,t+e.nodeSize,{},{isAnnotation:!0,id:r,data:a}))}),!0}),this.decorations=o.EH.create(e.doc,n),this.annotations=s}handleDropAnnotations(e,t,n){let{dragging:{origNodePos:o,inBlock:s,inCard:r},droppedBlockPos:a}=n,i=[];s.forEach(e=>{let t=e.pos-o,n=a+t;i.push({id:e.id,newPos:n})}),this.getAnnotationsBetween(e,a,a+1).filter(e=>!i.find(t=>t.id===e.id)).forEach(e=>{i.push({id:e.id,newPos:t.mapping.map(e.pos)})}),r.filter(e=>!i.find(t=>t.id===e.id)).forEach(e=>{let n=t.mapping.map(e.pos);i.push({newPos:n,id:e.id})}),this.log("%c[Annotations] handleDropAnnotations","color: green",{action:n,tr:t,toMove:i}),i.length>0&&this.enqueueMoveInstructions(i)}handleLocalChange(e){let t=[...this.decorations.find(void 0,void 0,e=>e.isAnnotation&&this.moveInstructionMap[e.id])],n=this.decorations.remove(en()(t)).map(e.mapping,e.doc).add(e.doc,t);return this.decorations=n,this}absToRel(e,t){let n=(0,ei.jS)(e,t);if(!n)throw Error("Y.State non initialized");return n}relToAbs(e,t){return(0,ei.XV)(e,t)}refreshRelativePos(e,t){let n=q.Gt.getState(e),{doc:o,type:s,binding:r}=n,a=(0,ee.SF)(o,s,t,r.mapping);return(0,ee.JR)(a,s,r.mapping)}enqueueMoveInstructions(e){e.forEach(e=>{let t=this.moveInstructionMap[e.id];t&&console.error("[AnnotationState] trying to enqueue two move instructions for annotation with targetId=".concat(e.id)),this.moveInstructionMap[e.id]=e})}enqueueRefreshDecorations(){this.refreshDecorations=!0}transactYDoc(e){this.options.document.transact(e)}log(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];S.VH.get("debugComments")?console.log(...t):console.debug(...t)}constructor(e){this.options=e,this.decorations=o.EH.empty,this.annotations=[],this.refreshDecorations=!1,this.hasChanges=!1,this.filmstripCutData=null,this.cutData=null,this.moveInstructionMap={},this.map=e.map,this.restoreMap=e.restoreMap,this.undoableMap=new ed(this.map)}}let eh=e=>{let t=K()(e=>{let t=X.Z.getState(e.state);t.persistRestoreMap(e.state)},500);return new I.Sy({key:X.Z,state:{init:()=>new eu(e),apply:(e,t,n,o)=>t.apply(e,o)},view:()=>({update(e){t(e)}}),props:{transformPasted(t){var n;let o=this.getState(e.editor.state),s=null===(n=t.content.firstChild)||void 0===n?void 0:n.attrs.docId;return s&&s!==e.editor.gammaDocId&&o.clearCutData(),t},handleDOMEvents:{copy(e){return this.getState(e.state).clearCutData(),!1}},decorations(t){let{decorations:n,annotations:o}=this.getState(t);return e.onUpdate&&e.onUpdate(n.find().map(e=>new W(e)),o),n}}})},ep=k.hj.create({name:"annotation",onCreate(){let e=function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];S.VH.get("debugComments")?console.log(...t):console.debug(...t)};this.options.document.on("afterAllTransactions",t=>{let n=X.Z.getState(this.editor.view.state),o=n.flushMoveInstructionQueue();o.length>0?(e("%c[Annotations] afterAllTransactions handling queued moves","color:pink",o),this.editor.commands.moveAnnotations(o)):n.refreshDecorations&&(e("%c[Annotations] afterAllTransactions refreshDecorations","color:pink"),this.editor.commands.refreshDecorations())});let t=X.Z.getState(this.editor.state);window.gammaAnnotations=t;let n=q.Gk.getState(this.editor.state).undoManager;setTimeout(()=>{n.on("stack-item-popped",e=>{let o=e.stackItem.meta.get("annotations");if(!o){t.persistRestoreMap(this.editor.state,!0);return}let{undoStack:s,redoStack:r}=n;"undo"===e.type&&r.length>0?r[r.length-1].meta.set("annotations",ec(o)):"redo"===e.type&&s.length>0&&s[s.length-1].meta.set("annotations",ec(o)),t.restore(this.editor.state,o)})},0),t.map.observe(K()(()=>{e("[Annotations] map observe -> resfreshDecorations"),this.editor.commands.refreshDecorations()})),this.editor.commands.refreshDecorations()},addCommands:()=>({restoreAnnotations:e=>t=>{let{dispatch:n,tr:o}=t;return n&&(o.setMeta(X.Z,{type:"restoreAnnotations",toRestore:Object.values(e)}),n(o)),!0},updateAttributes:function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return n=>{var o,s;let{tr:r,state:a,dispatch:i}=n,l=null,c=null,d=(o="string"==typeof e?e:e.name,(s=a.schema).nodes[o]?"node":s.marks[o]?"mark":null);return!!d&&("node"===d&&(l=(0,k.jo)(e,a.schema)),"mark"===d&&(c=(0,k.TP)(e,a.schema)),i&&r.selection.ranges.forEach(e=>{let n=e.$from.pos,o=e.$to.pos;a.doc.nodesBetween(n,o,(e,s)=>{l&&l===e.type&&r.setNodeMarkup(s,void 0,{...e.attrs,...t}).setMeta("annotationEvent",{type:"update-node-attrs",pos:s}),c&&e.marks.length&&e.marks.forEach(a=>{if(c===a.type){let i=Math.max(s,n),l=Math.min(s+e.nodeSize,o);r.addMark(i,l,c.create({...a.attrs,...t}))}})})}),!0)}},wrapWithAnnotations:(e,t)=>n=>{let{state:o,tr:s,dispatch:r}=n,a=o.schema.nodes[e],{$from:i,$to:l}=o.selection,c=i.blockRange(l),d=c&&(0,G.nd)(c,a,t);if(!d||!c)return!1;let{start:u,end:h}=c;return!r||(s.wrap(c,d).setMeta("annotationEvent",{type:"wrap-nodes",start:u,end:h,level:1}).scrollIntoView(),!0)},moveAnnotations:e=>t=>{let{dispatch:n,tr:o}=t;return n&&(o.setMeta(X.Z,{type:"moveAnnotations",toMove:e}),n(o)),!0},clearAnnotations:()=>e=>{let{dispatch:t,tr:n}=e;return t&&(n.setMeta(X.Z,{type:"clearAnnotations"}),t(n)),!0},refreshDecorations:()=>e=>{let{dispatch:t,tr:n}=e;return t&&(n.setMeta(X.Z,{type:"refreshAnnotationDecorations"}),t(n)),!0},addAnnotation:e=>{let{pos:t,id:n,data:o}=e;return e=>{let{dispatch:s,state:r}=e;return s&&r.tr.setMeta(X.Z,{type:"addAnnotation",id:n,data:o,pos:t}),!0}},deleteAnnotation:e=>t=>{let{dispatch:n,state:o}=t;return n&&o.tr.setMeta(X.Z,{type:"deleteAnnotation",id:e}),!0}}),addProseMirrorPlugins(){let{document:e,onUpdate:t}=this.options,n=new Z(e);return[eh({document:e,editor:this.editor,map:n.annotations,restoreMap:n.annotationsAbsolute,onUpdate:t})]}});var em=n(17010);let eg=k.hj.create({name:"draftComments",addCommands:()=>({removeDraftComments:e=>t=>{let{dispatch:n,tr:o}=t;if(n){let t={type:"removeDraftComment",comments:Array.isArray(e)?e:[e]};o.setMeta(em.N,t),n(o)}return!0},createDraftComment:e=>t=>{let{dispatch:n,tr:o}=t;return n&&(o.setMeta(em.N,{type:"createDraftComment",comment:e}),n(o)),!0}}),addProseMirrorPlugins:()=>[(0,em.O)()]});var ef=n(90221);let ey=new I.H$("mobileAnnotationPluginKey");class ev{apply(e,t){let n=e.getMeta(ey);return n&&"setPos"in n&&(this.pos=n.setPos),this}constructor(){this.pos=null}}let eS=k.hj.create({name:"mobileAnnotation",addCommands:()=>({setMobileAddBlockComment:e=>t=>{let{dispatch:n,tr:o,view:s}=t;if(!n)return!1;if(null===e)return o.setMeta(ey,{setPos:null}),n(o),!0;let{clientX:r,clientY:a}=e,i=s.posAtCoords({left:r,top:a});if(null===i)return!0;let l=(0,el.f$)(i.inside,s);if(!l)return!1;let c=s.coordsAtPos(l.pos),d=r-c.left,u=a-c.top;return o.setMeta(ey,{setPos:{pos:l.pos,end:l.end,offsetX:d,offsetY:u}}),n(o),!0}}),addProseMirrorPlugins(){return[function(e){let t=new I.Sy({key:ey,state:{init:()=>new ev,apply:(e,t,n,o)=>t.apply(e,o)},props:{handleDOMEvents:{click(t,n){if(!(0,ef.s2)())return!1;let o=n.target;if(o.closest("[data-comments-wrapper]"))return;let s=ey.getState(t.state);s.pos||(s.timeout?(clearTimeout(s.timeout),s.timeout=null,e.commands.setMobileAddBlockComment(n)):s.timeout=setTimeout(()=>{s.timeout=null},300))}},decorations(e){let t=ey.getState(e),n=t.pos;if(null===n)return o.EH.empty;let s=o.p.node(n.pos,n.end,{},{isMobileAnnotation:!0,type:"show-buttons",offsetX:n.offsetX,offsetY:n.offsetY});return o.EH.create(e.doc,[s])}}});return t}(this.editor)]}});var eb=n(62047);let ew=k.hj.create({name:"BlockHover",addProseMirrorPlugins(){return[(0,eb.RT)(this.editor)]}});var eA=n(77220),eM=n(8776),eC=n(11050),eE=n(52808);let eD=k.hj.create({name:"editCardAI",onTransaction(e){var t;let{transaction:n}=e;if(!n.docChanged||n.getMeta("isEditCardVariant")||!this.editor.isEditable||!S.VH.get("editCard2"))return;let o=null===(t=n.getMeta(q.Gt))||void 0===t?void 0:t.isUndoRedoOperation;o?eI(n):ek(n)}}),ek=K()(e=>{try{let t=(0,A.bh)(),n=t.getState(),o=(0,eM.Ir)(n);if(0===Object.keys(o).length)return;let s=(0,eE.Z)(e);s.forEach(n=>{let s={from:n.newStart,to:n.newEnd},r=(0,k.b5)(e.doc,s,e=>(0,x.KH)(e)&&!!o[e.attrs.id]);r.length&&r.forEach(e=>{var n;let{node:s}=e,r=s.attrs.id;console.debug("Clearing suggestions for card",r),null===eC.co||void 0===eC.co||eC.co.track(eC.AA.AI_CARD_VARIATION_KEPT,{cardId:r,variantId:o[r].selected,isOriginal:null===(n=o[r].variants.find(e=>e.id===o[r].selected))||void 0===n?void 0:n.isOriginal,interactionId:o[r].interactionId,source:"edit"}),t.dispatch((0,eM.Mq)({cardId:r}))})})}catch(e){console.error("[caught] EditCard clearSuggestions error",e)}},250),eI=e=>{try{let t=e.steps[0];if(!t||!(t instanceof G.Pu))return;let n=t.slice.content,o=(0,A.bh)(),s=o.getState(),r=(0,eM.Ir)(s);if(0===Object.keys(r).length)return;n.descendants(e=>{if(!(0,x.KH)(e))return;let t=e.attrs.id,n=r[t];if(!n)return;let s=n.variants.find(t=>JSON.stringify(t.card)===JSON.stringify(e.toJSON()));s&&o.dispatch((0,eM.dx)({cardId:t,variantId:s.id}))})}catch(e){console.error("[caught] EditCard updateVariations error",e)}};var eP=n(99720),eT=n(56143),ex=n(75487),e_=n(19283);let eR=k.hj.create({name:"collaboration",priority:e_.a.Collaboration,addOptions:()=>({document:null,field:"default",fragment:null}),onCreate(){this.editor.extensionManager.extensions.find(e=>"history"===e.name)&&console.warn('[tiptap warn]: "@tiptap/extension-collaboration" comes with its own history support and is not compatible with "@tiptap/extension-history".')},addCommands:()=>({undo:()=>e=>{let{tr:t,state:n,dispatch:o}=e;t.setMeta("preventDispatch",!0);let s=q.Gk.getState(n).undoManager;return 0!==s.undoStack.length&&(!o||(0,eT.Yw)(n)||!0)},redo:()=>e=>{let{tr:t,state:n,dispatch:o}=e;t.setMeta("preventDispatch",!0);let s=q.Gk.getState(n).undoManager;return 0!==s.redoStack.length&&(!o||(0,eT.KX)(n)||!0)}}),addKeyboardShortcuts(){return{"Mod-z":()=>this.editor.commands.undo(),"Mod-y":()=>this.editor.commands.redo(),"Shift-Mod-z":()=>this.editor.commands.redo()}},addProseMirrorPlugins(){let e=this.options.fragment?this.options.fragment:this.options.document.getXmlFragment(this.options.field);return[(0,ex.Z)(e),(0,eT.v0)()]}}),eN=()=>new I.Sy({key:new I.H$("undoHistoryPlugin"),appendTransaction(e,t,n){if(e.some(e=>!1==e.getMeta("addToHistory"))){let e=n.tr;return e.setMeta("addToHistory",!1),e}return null}}),eO=k.hj.create({name:"undoHistory",priority:e_.a.UndoHistory,addProseMirrorPlugins:()=>[eN()],addCommands:()=>({noUndo:()=>e=>{let{tr:t}=e;return t.setMeta("addToHistory",!1),!0}})});var ej=n(67702),ez=n(98537),eH=n.n(ez),eB=n(98621),eL=n.n(eB);let eU=()=>null,eV=e=>Array.from(e.entries()).map(e=>{let[t,n]=e;return{clientId:t,...n.user}}),eq=k.hj.create({name:"collaborationCursor",addOptions:()=>({provider:null,user:{name:null,color:null},render:e=>{let t=document.createElement("span");if(!e.isReady)return t;t.classList.add("collaboration-cursor__caret"),t.setAttribute("style","border-color: ".concat(e.color));let n=document.createElement("div");n.classList.add("collaboration-cursor__label"),n.setAttribute("style","background-color: ".concat(e.color,"; color: ").concat(eL()(e.color).isDark()?"white":"black"));let o=e.name.split(" ")[0];return n.insertBefore(document.createTextNode(o),null),t.insertBefore(n,null),t},onUpdate:eU}),addStorage:()=>({users:[]}),addCommands(){return{user:e=>()=>(this.options.user=eH()({},this.options.user,e),this.options.provider.awareness.setLocalStateField("user",this.options.user),!0)}},addProseMirrorPlugins(){return[(0,ej.JL)((this.options.provider.awareness.setLocalStateField("user",this.options.user),this.storage.users=eV(this.options.provider.awareness.states),this.options.provider.awareness.on("update",()=>{this.storage.users=eV(this.options.provider.awareness.states)}),this.options.provider.awareness),{cursorBuilder:this.options.render})]}});var eF=n(65301);let eK=k.hj.create({name:"globalDragHandle",priority:e_.a.GlobalDragHandle,addOptions:()=>({scrollerSelector:"body"}),addStorage:()=>({enabled:!0}),addProseMirrorPlugins(){return[(0,eF.f)({editor:this.editor,storage:this.storage,scrollerSelector:this.options.scrollerSelector})]},extendNodeSchema(e){var t;return{containerHandle:null!==(t=(0,k.nU)((0,k.Nl)(e,"containerHandle",e)))&&void 0!==t&&t}}});var eG=n(17487),e$=n(3892),eJ=n(12483);let eQ=new I.H$("erasingContent");class eY{toJSON(){return{datetime:this.timestamp.toISOString(),meta:this.tr.meta,steps:this.tr.steps.map(e=>e.toJSON())}}constructor(e){this.tr=e,this.timestamp=new Date(new Date().toLocaleString("en-US",{timeZone:"America/Los_Angeles"}))}}class eZ{apply(e,t){return e.docChanged&&(this.transactions.unshift(new eY(e)),this.transactions.length>5&&this.transactions.pop()),this}constructor(){this.transactions=[]}}class eW extends Error{constructor(e){super(e||"Content erased"),this.name="ContentErasedError"}}let eX=k.hj.create({name:"ErasingContent",addProseMirrorPlugins(){let e=this,t=t=>{try{var n;let o=(0,E.ts)(),s=this.options.messageLogger.flushMessages();for(let t of s){let n={...t.toDebugObject(),clientID:e.options.provider.document.clientID};e$.fy.logger.info(t.toString(),n),console.log(t.toString(),n)}let r=Math.floor(performance.now()-this.options.startTime),a={event:"CONTENT_ERASED",didFilterTransaction:t.didFilterTransaction,tr:t.tr.toJSON(),prevTrs:null===(n=t.prevTrs)||void 0===n?void 0:n.map(e=>e.toJSON()),timeSinceOpened:r,isBackgrounded:!!document.hidden,docId:this.options.provider.configuration.name,clientID:this.options.provider.document.clientID,userId:null==o?void 0:o.id};e$.fy.logger.error("[ErasingContent] ".concat(r," content erased (FILTERED: ").concat(t.didFilterTransaction,")"),a),eJ.Tb(new eW)}catch(e){console.error("Failed to log content erased",e),eJ.Tb(e)}};return[new I.Sy({key:eQ,filterTransaction:(e,n)=>{if(!e.docChanged)return!0;let o=n.doc.type.createAndFill().content,s=e.doc.content.findDiffStart(o);if(null===s){let o=new eY(e),s=eQ.getState(n),r=S.VH.get("filterContentErasingTrs");return t({tr:o,didFilterTransaction:r,prevTrs:null==s?void 0:s.transactions}),!r}return!0},state:{init:()=>new eZ,apply:(e,t,n,o)=>t.apply(e,o)}})]}});var e0=n(97857),e1=n(22662);let e2=k.hj.create({name:"filmstrip",onCreate(){let e=q.Gk.getState(this.editor.state).undoManager;e.on("stack-item-popped",t=>{let{undoStack:n,redoStack:o}=e,s=t.stackItem.meta.get("filmstripState");if(!s)return;let r=(0,e1.sy)((0,A.bh)().getState());"undo"===t.type&&o.length>0?o[o.length-1].meta.set("filmstripState",r):"redo"===t.type&&n.length>0&&n[n.length-1].meta.set("filmstripState",r),(0,A.bh)().dispatch((0,e1.tE)(s))})}});var e5=n(45534),e8=n(97253),e4=n(23450),e3=n(80393);let e7=k.hj.create({name:"scrollMargin",addProseMirrorPlugins:()=>[new I.Sy({props:{scrollMargin:e3.Sf,scrollThreshold:e3.Sf}})]});var e6=n(13653),e9=n(74585),te=n(61750),tt=n(47968),tn=n(41425),to=n(332),ts=n(38035),tr=n(82554),ta=n(82108),ti=n.n(ta),tl=n(67748);let tc=e=>{let{editor:t}=e,[n,o]=(0,m.useState)(null);(0,m.useEffect)(()=>{if(!t)return;let e=()=>{o(t.state.selection)};return e(),t.on("selectionUpdate",e),()=>{t.off("selectionUpdate",e)}},[t]);let r=n instanceof I.qv,a=n instanceof tl.c,i=ti()((null==n?void 0:n.toJSON().type)||"none"),c=ti()(r&&(null==n?void 0:n.node.type.name)||""),d=a?void 0:r?"blue":"green";return(0,s.jsx)(to.h,{children:(0,s.jsx)(ts.k,{className:"selection-debugger",position:"absolute",top:"50px",left:"10px",zIndex:"999999",children:(0,s.jsxs)(l.K,{direction:"column",children:[(0,s.jsxs)(tr.C,{colorScheme:d,children:[i,c&&(0,s.jsxs)("i",{children:[" (",c,")"]})]}),n&&(0,s.jsxs)(tr.C,{colorScheme:"gray",children:["f:",n.from," - t:",n.to,a&&" | side:".concat(n.side)]})]})})})};var td=n(37164),tu=n(43997),th=n(18733),tp=n(88640);let tm=(0,td.kP)("1234567890",10),tg=()=>{let e=th.Q.getItem(tp.H.sessionId);if(e)return e;let t="".concat(+new Date,"__").concat(tm());return th.Q.setItem(tp.H.sessionId,t),t},tf=(e,t)=>{let{user:n,isUserLoading:o,anonymousUser:s,color:r}=(0,E.SE)(),a=(0,m.useRef)(!1),i=(0,tu.I0)(),l=(0,m.useMemo)(()=>tg(),[]),c=(0,A.CG)(tt._O),d=(0,m.useMemo)(()=>{let e=(null==n?void 0:n.id)||s.id;return{id:e,color:r.value,sessionId:c?l+"__pv":l,isPresenterView:c,idleSince:null,name:(null==n?void 0:n.displayName)||s.displayName||"",profileImageUrl:(null==n?void 0:n.profileImageUrl)||"",isReady:!o,spotlight:{pos:null,cardId:null}}},[n,r,o,c,s,l]);(0,m.useEffect)(()=>{if(!e||e.isDestroyed||!(null==t?void 0:t.awareness))return;e.commands.user(d),!a.current&&d.isReady&&(e.chain().blur().focusDelayed().run(),a.current=!0),i((0,tt.MU)({sessionId:d.sessionId}));let n=(e,n)=>{let{added:o,updated:s,removed:r}=e;requestIdleCallback(()=>{if(!t.awareness)return;let e=eV(t.awareness.states);i((0,tt.Tx)({collaborators:e}))},{timeout:500})};t.awareness.on("change",n);let o=K()(n,tt.Jp);return t.awareness.on("update",o),()=>{var e,s;null===(e=t.awareness)||void 0===e||e.off("change",n),null===(s=t.awareness)||void 0===s||s.off("update",o)}},[d,e,t,i]),(0,m.useEffect)(()=>{if(!e)return;let t=K()(t=>{e.commands.user(t)},10);return(0,A.tC)(tt.gL,t)},[e])};var ty=n(4576),tv=n(46201),tS=n(38849),tb=n.n(tS),tw=n(21733);let tA=e=>JSON.stringify(Array.from(e.entries())),tM=e=>JSON.stringify(Array.from(e)),tC=e=>Array.from(e.entries()),tE=e=>e instanceof f.ck?{__type:e.constructor.name,id:e.id,length:e.length,info:e.info,parent:e.parent,parentSub:e.parentSub,content:{__type:e.content.constructor.name,...e.content}}:e,tD=()=>{let e=(0,tv.Mf)();return(0,tv.uw)(e,""),(0,tv.uE)(e,h.Cs.Sync),(0,tv.uE)(e,1),(0,tv.mP)(e,new Uint8Array([])),(0,tv._f)(e)};class tk{setTransaction(e){this.transaction=e}shouldAssociateTransaction(){return!1}getPayload(){return{}}toString(){let e="in"===this.dir?"\uD83D\uDFE9⬇️":"\uD83D\uDFE6⬆️",t=tb()(String(this.timestamp),5);return"".concat("[HocuspocusMessage]"," ").concat(t," ").concat(e," ").concat(this.typeName)}toDebugObject(){var e;return{event:"hocuspocus-message",docId:this.docId,userId:null===(e=(0,tw.ts)())||void 0===e?void 0:e.id,hocuspocusMessage:{dir:this.dir,timestamp:this.timestamp,typeName:this.typeName,messageType:this.messageType,payload:this.getPayload()}}}static fromOutgoingMessage(e,t){let n=0===e.encoder.cpos&&0===e.encoder.bufs.length,o=n?tD():(0,tv._f)(e.encoder);return tk.fromData("out",o,t)}static fromIncomingMessage(e,t){return tk.fromData("in",new Uint8Array(e),t)}static fromData(e,t,n){let o=(0,ty.l1)(t),s=(0,ty.kf)(o),r=(0,ty.yg)(o);switch(r){case h.Cs.Sync:return new tI(s,e,o,n);case h.Cs.Awareness:return new tP(s,e,o,n);case h.Cs.Auth:return new tT(s,e,o,n);case h.Cs.QueryAwareness:return new tx(s,e,o,n);case h.Cs.Stateless:return new t_(s,e,o,n);case h.Cs.CLOSE:return new tR(s,e,o,n);case h.Cs.SyncStatus:return new tN(s,e,o,n);default:return new tk(s,e,n)}}constructor(e,t,n){this.docId=e,this.dir=t,this.timestamp=n,this.messageType=null,this.typeName="DebugHocuspocusMessage",this.transaction=null}}class tI extends tk{getPayload(){let{transaction:e}=this,t=null,n=null;if(0===this.syncStep){var o;o=this.update,t=JSON.stringify(tC(f.vP(o)))}else this.syncStep>0&&(n=function(e){try{let t=f.DN(new Uint8Array(e));return{ds:JSON.stringify(tC(t.ds.clients)),structs:JSON.stringify(t.structs.map(tE))}}catch(e){return{}}}(this.update));let s={syncStepName:this.syncStepName,syncStep:this.syncStep,update:tM(this.update),stateVector:t,decodedUpdate:n,transaction:null};return null!==e&&(s.transaction={beforeState:tA(e.beforeState),beforeStateSize:e.beforeState.size,afterState:tA(e.afterState),afterStateSize:e.afterState.size,changed:tA(e.changed),changedSize:e.changed.size,deleteSet:tA(e.deleteSet.clients),deleteSetSize:e.deleteSet.clients.size}),s}shouldAssociateTransaction(){return 2===this.syncStep}toString(){let e=super.toString();return"".concat(e," [step=").concat(this.syncStepName,"]")}constructor(e,t,n,o){super(e,t,o),this.messageType=h.Cs.Sync,this.typeName="Sync",this.syncStep=(0,ty.yg)(n),this.syncStepName=0===this.syncStep?"SyncStep1":1===this.syncStep?"SyncStep2":"Update",this.update=(0,ty.HN)(n)}}class tP extends tk{getPayload(){return{len:this.states.length,states:this.states}}constructor(e,t,n,o){super(e,t,o),this.messageType=h.Cs.Awareness,this.typeName="Awareness",this.states=[];let s=(0,ty.HN)(n),r=(0,ty.l1)(s),a=(0,ty.yg)(r);for(let e=0;e<a;e++){let e=(0,ty.yg)(r),t=(0,ty.yg)(r),n=(0,ty.kf)(r);this.states.push({clientId:e,clock:t,state:n})}}}class tT extends tk{getPayload(){return{authMessageType:this.authMessageTypeName,scope:this.scope}}toString(){let e=super.toString();return"".concat(e," [authType=").concat(this.authMessageTypeName,"]")}constructor(e,t,n,o){super(e,t,o),this.messageType=h.Cs.Auth,this.typeName="Auth",this.authMessageType=(0,ty.yg)(n),this.authMessageTypeName=0===this.authMessageType?"Token":1===this.authMessageType?"PermissionDenied":"Authenticated",this.scope=(0,ty.kf)(n)}}class tx extends tk{constructor(e,t,n,o){super(e,t,o),this.messageType=h.Cs.QueryAwareness,this.typeName="QueryAwareness"}}class t_ extends tk{constructor(e,t,n,o){super(e,t,o),this.messageType=h.Cs.Stateless,this.typeName="Stateless"}}class tR extends tk{constructor(e,t,n,o){super(e,t,o),this.messageType=h.Cs.CLOSE,this.typeName="Close"}}class tN extends tk{getPayload(){return{saved:this.saved}}constructor(e,t,n,o){super(e,t,o),this.messageType=h.Cs.SyncStatus,this.typeName="SyncStatus",this.saved=1===(0,ty.yg)(n)}}let tO=()=>{let e=(0,m.useRef)(null),t=(0,m.useCallback)(t=>{e.current=t},[]),n=(0,m.useCallback)(()=>{let t=e.current;return e.current=null,t},[]);return{onTransaction:t,getTransaction:n}};class tj{onMessage(e){e.messageType!==h.Cs.Awareness&&(this.buffer.push(e),this.buffer.length>this.bufferSize&&this.buffer.shift())}getMessages(){return this.buffer}flushMessages(){let e=this.buffer;return this.buffer=[],e}constructor(e=50){this.bufferSize=e,this.buffer=[]}}var tz=n(68015),tH=n.n(tz);let tB=e=>{let[t,n]=(0,m.useState)([]),o=(0,m.useCallback)(t=>{if(!e)return;let o=performance.now(),s={msg:t,timestamp:o};n(e=>{if(0===e.length)return[...e,s];let n=e.find(e=>e.msg===t);if(n)return e;let r=e[e.length-1];return r.msg===t?e:(s.duration=tH()(o-e[e.length-1].timestamp,2),[...e,s])})},[e]),s=(0,m.useCallback)(()=>{e&&n(e=>{try{console.table(e)}catch(e){}return[]})},[e]);return{logMessages:t,logPerfMessage:o,dumpLog:s}};var tL=n(62040),tU=n(60589);let tV="custom",tq="updates",tF=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:()=>{},[n]=tU.ay(e.db,[tq]);return tU.go(n,tU.sc(e._dbref,!1)).then(o=>{t(n),f.ay(e.doc,()=>{o.forEach(t=>f.NG(e.doc,t))},e,!1)}).then(()=>tU.S_(n).then(t=>{e._dbref=t+1})).then(()=>tU.QX(n).then(t=>{e._dbsize=t})).then(()=>n)},tK=function(e){let t=!(arguments.length>1)||void 0===arguments[1]||arguments[1];return tF(e).then(n=>{(t||e._dbsize>=500)&&tU.yP(n,f.D$(e.doc)).then(()=>tU.IV(n,tU.UE(e._dbref,!0))).then(()=>tU.QX(n).then(t=>{e._dbsize=t}))})};class tG extends $.y{destroy(){return this._storeTimeoutId&&clearTimeout(this._storeTimeoutId),this.doc.off("update",this._storeUpdate),this.doc.off("destroy",this.destroy),this._destroyed=!0,this._db.then(e=>{e.close()})}clearData(){return this.destroy().then(()=>{tU.Lj(this.name)})}get(e){return this._db.then(t=>{let[n]=tU.ay(t,[tV],"readonly");return tU.U2(n,e)})}set(e,t){return this._db.then(n=>{let[o]=tU.ay(n,[tV]);return tU.gz(o,t,e)})}del(e){return this._db.then(t=>{let[n]=tU.ay(t,[tV]);return tU.IV(n,e)})}constructor(e,t){super(),this.doc=t,this.name=e,this._dbref=0,this._dbsize=0,this._destroyed=!1,this.db=null,this.synced=!1,this._db=tU.X3(e,e=>tU._w(e,[["updates",{autoIncrement:!0}],["custom"]])),this.whenSynced=this._db.then(e=>(this.db=e,tF(this,e=>tU.yP(e,f.D$(t))).then(()=>(this._destroyed||(this.emit("synced",[this]),this.synced=!0),this)))),this._storeTimeout=1e3,this._storeTimeoutId=null,this._storeUpdate=(e,t)=>{if(this.db&&t!==this){let[t]=tU.ay(this.db,[tq]);tU.yP(t,e),++this._dbsize>=500&&(null!==this._storeTimeoutId&&clearTimeout(this._storeTimeoutId),this._storeTimeoutId=setTimeout(()=>{tK(this,!1),this._storeTimeoutId=null},this._storeTimeout))}},t.on("update",this._storeUpdate),this.destroy=this.destroy.bind(this),t.on("destroy",this.destroy)}}let t$=(e,t,n)=>{let o=new tG(e,t),s=K()(()=>{let e=t.getMap("SCHEMA_VERSION").get("REQUIRED_VERSION");o.set("lastUpdated",new Date().toISOString()),o.set("schemaVersion",e||"")},1e3);return t.on("update",s),o.on("synced",()=>{null==n||n()}),o};var tJ=n(74008),tQ=n(70065),tY=n(82655),tZ=n(49929),tW=n(5879),tX=n(48832),t0=n(4878);n(23147);let t1=async(e,t,n,o)=>{try{let{id:s,length:r}=n||{},a=await fetch("".concat(y.v.MULTIPLAYER_WS_URL.replace("wss","https"),"/").concat(e,"/verify/").concat(t),{method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({id:s,length:r,clientCount:null==o?void 0:o.clientCount,totalCount:null==o?void 0:o.totalCount})}),i=await a.json();return i}catch(e){}},t2=e=>{let t=e.document.store.clients.get(e.document.clientID);if(t&&t.length)return t[t.length-1]},t5=e=>{let t=e.document.store.clients.size,n=[...e.document.store.clients.values()].reduce((e,t)=>e+t.reduce((e,t)=>e+t.length,0),0);return{clientCount:t,totalCount:n}},t8=async(e,t,n)=>{let o=t2(t),s=t5(t),r=await t1(e.gammaDocId,t.document.clientID,o,s);if(!r)return console.warn("[compareClocks] Failed to fetch remote clock"),!1;try{var a;let e=((null==o?void 0:o.id.clock)||0)+((null==o?void 0:o.length)||0),t=((null==r?void 0:null===(a=r.lastKnownItem.id)||void 0===a?void 0:a.clock)||0)+((null==r?void 0:r.lastKnownItem.length)||0),i=e-t;i>0&&console.warn("[compareClocks] Clock drift detected",{diffLastItem:i});let l=s.clientCount-(r.itemSummary.clientCount||0),c=s.totalCount-(r.itemSummary.totalCount||0);return l>0&&console.warn("[compareClocks] clientCount drift detected",{diffClientCount:l}),c>0&&console.warn("[compareClocks] totalCount drift detected",{diffTotalCount:c}),0===l&&c<=n&&i<=n}catch(e){console.warn("[compareClocks] Failed to fetch remote clock")}return!1},t4=e=>{let{editor:t,yProvider:n,enabled:o,pollingInterval:s}=e,[r,a]=(0,m.useState)(Date.now()),[i,l]=(0,m.useState)(0),[c,d]=(0,m.useState)(0),u=(0,S.ye)("dataSyncClockDriftTolerance");return(0,m.useEffect)(()=>{let e;if(!t||!n||!o)return;let r=!0,i=async()=>{if(!t.gammaDocId)return;let o=await t8(t,n,u);o?a(Date.now()):console.warn("[useDataPersistenceSync_2] Clocks out of sync for doc",t.gammaDocId),requestIdleCallback(()=>{l(e=>o?0:e+1),d(e=>0),r&&(e=window.setTimeout(i,s))})};return i(),()=>{clearTimeout(e),r=!1}},[t,n,o,s,u]),{errorCountClock:i,errorCountPMState:c,yDocLastSynced:r}},t3=/^[\w\d\t\n ,./<>?;:"'`!@#$%^&*()[\]{}_+=|\\-]$/u,t7=e=>{let{editor:t,pollingInterval:n}=e,o=(0,m.useRef)(Date.now()),s=(0,m.useRef)(Date.now()),[r,a]=(0,m.useState)(0);return(0,m.useEffect)(()=>{if(!t)return;let e=e=>{!e.metaKey&&e.key.match(t3)&&(o.current=Date.now())},r=e=>{let{transaction:t}=e;t.docChanged&&(o.current=Date.now(),s.current=Date.now())};t.on("update",r),t.view.dom.addEventListener("keydown",e,!0);let i=setInterval(()=>{let e=s.current-o.current;e>500?(console.error("[useDataPersistenceSync_0] Delay to capture changes has exceeded threshold"),a(e=>e+1)):a(0)},n);return()=>{clearInterval(i),t.off("update",r),t.view.dom.removeEventListener("keydown",e,!0)}},[t,n]),r},t6="data-sync-error-toast",t9=(0,s.jsx)(tZ.G,{icon:tY.xHz,size:"2x"}),ne=(0,s.jsx)(tZ.G,{icon:tY.ik8,size:"2x"}),nt=e=>{let{type:t,yDocLastSynced:n}=e;return()=>(0,s.jsx)(ts.k,{direction:"column",p:4,color:"white",bg:"warn"===t?"yellow.500":"red.500",borderRadius:"md",children:(0,s.jsxs)(ts.k,{alignItems:"center",children:["warn"===t?t9:ne,(0,s.jsxs)(a.xu,{ml:3,children:[(0,s.jsx)(d.x,{lineHeight:6,fontSize:"sm",fontWeight:"bold",children:"warn"===t?(0,s.jsx)(tW.cC,{id:"IkN23t"}):(0,s.jsx)(tW.cC,{id:"kXEHsK"})}),n&&(0,s.jsx)(d.x,{lineHeight:6,fontSize:"sm",children:(0,s.jsx)(tW.cC,{id:"VxWwaW",values:{0:(0,tX.Dw)(new Date(n).toISOString())}})}),"error"===t&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(tJ.i,{pt:2}),(0,s.jsx)(d.x,{lineHeight:6,fontSize:"sm",pt:2,children:(0,s.jsx)(tW.cC,{id:"Pw5K5r"})})]})]})]})})},nn=e=>{let{editor:t,yProvider:n,enabled:o}=e,s=(0,A.CG)(tt.Tf),r=(0,t0.Br)("comment"),a=(0,A.CG)(tt.q7),[i,l]=(0,m.useState)(2e4),c=(0,eC.z$)(),d=(0,tQ.p)(),{user:u}=(0,E.SE)(),h=(0,m.useRef)(),p=(0,S.ye)("dataSyncErrorThreshold"),g=t7({editor:t,pollingInterval:i}),{errorCountPMState:f,errorCountClock:y,yDocLastSynced:v}=t4({editor:t,yProvider:n,enabled:o&&r,pollingInterval:i}),b={docSavedTime:a,yDocLastSynced:v,errorCountKeyboard:g,errorCountPMState:f,errorCountClock:y,clientID:null==n?void 0:n.document.clientID,userId:null==u?void 0:u.id},w=(0,m.useRef)(b);w.current=b;let M=y+f;(0,m.useEffect)(()=>{l(0===M?2e4:4e3)},[M]);let C=o&&-1!==p&&M>p,D=o&&-1!==p&&M/p>2;return(0,m.useEffect)(()=>{if(!C||s){if(d.isActive(t6)){d.close(t6);let e=h.current?+new Date-+h.current:void 0;null==c||c.trackDocEvent(eC.xW.DATA_SYNC_RECOVER,{...w.current,duration:e}),h.current=void 0}return}let e=nt({type:D?"error":"warn",yDocLastSynced:v});d.isActive(t6)?d.update(t6,{render:e}):(null==c||c.trackDocEvent(eC.xW.DATA_SYNC_ERROR,w.current),h.current=new Date,d({render:e,duration:null,id:t6})),D&&console.error("[useDataPersistenceSync] ERROR_THRESHOLD_EXCEEDED. docId:",null==t?void 0:t.gammaDocId)},[t,d,c,D,C,a,v,s]),D},no=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e3,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5,n=(0,m.useRef)(0),o=(0,m.useRef)(0),[s,r]=(0,m.useState)(!1),[a,i]=(0,m.useState)(0),[l,c]=(0,m.useState)(document.hidden),d=(0,m.useRef)(()=>{n.current++;let a=n.current>=t;if(a&&(console.warn("[useRateLimiter] Limit hit! (".concat(t," per ").concat(e/1e3,"s)")),s||(r(!0),i(e=>e+1))),!o.current){let s=e/t;o.current=g.Zi(()=>{n.current>0?n.current--:(r(!1),g.cv(o.current),o.current=0)},s)}});return(0,m.useEffect)(()=>{let e=()=>{c(document.hidden),d.current()};return document.addEventListener("visibilitychange",e),()=>document.removeEventListener("visibilitychange",e)},[]),[d.current,s,a,l]};var ns=n(17993),nr=n(62614);let na=()=>(0,s.jsxs)(ns.g,{align:"flex-end",borderRadius:"base",shadow:"lg",p:3,bg:"gray.100",spacing:4,maxW:"300px",direction:"row",children:[(0,s.jsxs)(a.xu,{children:[(0,s.jsx)(d.x,{fontSize:"md",fontWeight:"bold",children:(0,s.jsx)(tW.cC,{id:"oSUMyx"})}),(0,s.jsxs)(d.x,{fontSize:"sm",children:[(0,s.jsx)(tW.cC,{id:"CDva2g"})," ",(0,s.jsx)("em",{children:(0,s.jsx)(tW.cC,{id:"/vuJlA"})})," ","\uD83D\uDE0E"]})]}),(0,s.jsx)(a.xu,{children:(0,s.jsx)(nr.z,{size:"sm",onClick:()=>{window.location.reload()},children:(0,s.jsx)(tW.cC,{id:"HpK/8d"})})})]}),ni=e=>{let t=(0,tQ.p)(),[n,o]=(0,m.useState)(!1);return(0,m.useEffect)(()=>{if(!e)return;let t=()=>{let t=e.getMap("SCHEMA_VERSION").get("REQUIRED_VERSION"),n=!!(t&&t>tn.bI);o(n),console[n?"warn":"debug"]("[SchemaVerifier] onUpdate",{requiredVersion:t,MY_VERSION:tn.bI,outdated:n})};return e.on("update",t),()=>{e.off("update",t)}},[e]),(0,m.useEffect)(()=>{n&&!t.isActive("schema_outdated")&&t({id:"schema_outdated",duration:null,status:"warning",isClosable:!1,position:"bottom-left",render:na})},[n,t]),n},nl=e=>({DOC_ID:e,SCHEMA_VERSION:String(tn.bI),SHARE_TOKEN:y.v.SHARE_TOKEN}),nc=(0,m.memo)(e=>{let{doc:t,docId:n,onCreate:o,readOnly:k=!1,scrollingParentSelector:I,hideForPreview:P=!1,animationsExtensionEnabled:T=!1}=e,[x]=(0,m.useState)(()=>performance.now()),{timeOnCreate:_,timeOnSetupProvider:N,timeOnDownloadDoc:O}=(0,w.bf)(),H=(0,M.Yy)(),[B,L]=(0,m.useState)("connecting"),[q,F]=(0,m.useState)(!1),K=(0,m.useRef)(!1);K.current=q;let[G,$]=(0,m.useState)(!1),J=(0,m.useRef)([]),[Q,Y]=(0,m.useState)(),[Z,W]=(0,m.useState)(),[X,ee]=(0,m.useState)(),[et,en]=(0,m.useState)(),[eo]=(0,m.useState)(()=>new tj),{onTransaction:es,getTransaction:er}=tO(),ea=ni(Z);tf(Q,X),(0,te.jB)(Q);let[ei,el,ec,ed]=no(),eu=t&&t.organization&&t.organization.id,{isConnected:eh,setHocuspocusConnected:em}=(0,v.$gs)(),ef=nn({editor:Q,yProvider:X,enabled:eh&&!ed&&!k}),ey=(0,b.y)("debugLogging"),ev=(0,b.y)("debugCardViewed"),eb=(0,b.y)("offline"),eM=(0,A.TL)(),{logMessages:eC,logPerfMessage:eE,dumpLog:ek}=tB(ey);(0,m.useEffect)(()=>{eb&&X&&!et&&en(t$(n,X.document,()=>{let e=X.document.getMap("SCHEMA_VERSION").get("REQUIRED_VERSION");"number"==typeof e&&(F(!0),$(!0))}))},[eb,X,n,et]),(0,E.$K)((0,m.useCallback)(()=>{X&&(X.disconnect(),X.configuration.parameters=nl(n),setTimeout(()=>X.connect(),500))},[X,n])),(0,tL.n)(Q),(0,m.useEffect)(()=>{em(K.current||"connected"===B||ed)},[em,B,ed]),(0,r.z)(()=>em(null),[]),(0,m.useEffect)(()=>{let e;if(!X)return;let t=ec>10;if(el){console.warn("[CollaborativeEditor] Attempted to re-connect while rate limited (".concat(ec," of ").concat(10,").")),X.disconnect();return}if(t){console.error("[CollaborativeEditor - RECONNECT_RATE_LIMIT] Max rate limit violations reached (".concat(10,"). Will reload.")),setTimeout(()=>{window.location.reload()},500);return}if(K.current)return ed?(console.debug("[CollaborativeEditor] Backgrounded, will wait ".concat(12e4,"s before disconnect")),e=g.iK(()=>{console.debug("[CollaborativeEditor] Disconnecting after grace period"),X.disconnect()},12e4)):(console.debug("[CollaborativeEditor] Foregrounded, so re-connecting"),X.connect()),()=>{e&&g.gr(e)}},[X,ed,el,ec]),(0,m.useEffect)(()=>{Q&&!Q.isDestroyed&&eu&&(Q.commands.initializeUploadExtension(eu),Q.commands.removeGeneratorInputsOnLoad())},[Q,eu]),(0,m.useEffect)(()=>{console.debug("[CollaborativeEditor] Creating yProvider for doc",n);let e=new f.QW({});e.getXmlFragment("default").observeDeep((e,t)=>{es(t)}),W(e),eE("Setting up hocuspocus"),N();let t=new h.Ui({name:n,document:e,forceSyncInterval:15e3,token:nl(n).SHARE_TOKEN||"null",websocketProvider:new h.cA({url:y.v.MULTIPLAYER_WS_URL,maxAttempts:25,parameters:nl(n)}),preserveConnection:!1,onOutgoingMessage(e){let{message:t}=e;try{let e=Math.floor(performance.now()-x),n=tk.fromOutgoingMessage(t,e);n.shouldAssociateTransaction()&&n.setTransaction(er()),eo.onMessage(n)}catch(e){console.error("[CollaborativeEditor] Error processing outgoing message for debug",e)}},onMessage(e){let{message:t}=e;try{let e=Math.floor(performance.now()-x),n=tk.fromIncomingMessage(t.data,e);n.shouldAssociateTransaction()&&n.setTransaction(er()),eo.onMessage(n)}catch(e){console.error("[CollaborativeEditor] Error processing incoming message for debug",e)}},onOpen(){if(!0===S.VH.get("hocuspocusOnAuthenticate")){console.log("[CollaborativeEditor] Provider opened. onAuthenticate is enabled so this is a no-op.");return}t.isAuthenticated=!0,console.log("[CollaborativeEditor] Provider opened.  Setting isAuthenticated to true.")},onStatus(e){let{status:t}=e;console.debug("[CollaborativeEditor][onStatus]",{status:t}),L(t),"connected"===t?(eE("Hocuspocus connected"),F(!0),K.current=!0):"connecting"===t&&(eE("Hocuspocus connecting"),ei())},onSynced(){console.debug("[CollaborativeEditor] Provider synced"),$(!0),eE("Document data downloaded")},onDisconnect(e){let{event:t}=e;console.debug("[CollaborativeEditor][onDisconnect]",{event:t}),t.code===u.NI.code&&console.error('[CollaborativeEditor] Provider disconnected with "Unauthorized.code", which is unexpected.',t)}});return t.subscribeToBroadcastChannel(),ee(t),eM((0,tt.Y8)({hocuspocusProvider:t})),y.v.DEBUG_ENABLED&&(window.gammaEditorProvider=t),J.current=[...T?[V.F]:[],e5.zL,e7,te.$1.configure({scrollerSelector:I}),eR.configure({document:e}),eO,R.configure({provider:t}),eq.configure({provider:t}),ep.configure({document:e}),eS,ew,eg.configure(),eA.NM,e9.W,j.configure({document:e}),U,e4.L,eG.Pi,e8.R,e0._g,e6.Jn,p.ZT.configure({openDoubleQuote:!1,closeDoubleQuote:!1,openSingleQuote:!1,closeSingleQuote:!1}),eK.configure({scrollerSelector:I}),z.F,eP.B,eD,e2,C.p.configure({document:e}),eX.configure({startTime:x,messageLogger:eo,provider:t})],()=>{console.warn("[CollaborativeEditor] Destroying yProvider for doc ➡️",n),t.disconnect(),t.destroy(),delete window.gammaEditorProvider,ee(void 0),$(!1),F(!1),setTimeout(()=>{if(t&&t.awareness)try{t.awareness.destroy()}catch(e){console.warn("[CollaborativeEditor] Error destroying awareness provider.")}})}},[T,eM,n,eE,ei,I,x,N,eo,es,er]);let eI=!!(q&&G);(0,m.useEffect)(()=>{eI&&(eE("Is ready for TipTap"),O())},[eI,O,eE]);let eT=!eb&&(!eh||ef);return(0,s.jsxs)(a.xu,{display:P?"none":"block",w:"100%","data-testid":"collaborative-editor-wrapper",children:[eI&&ev&&(0,s.jsx)(tc,{editor:Q}),!Q&&(0,s.jsx)(a.xu,{flexDirection:"column",flex:"1",w:"100%",h:"var(--100vh)",bg:H?"gray.900":"gray.100",zIndex:"overlay","data-testid":"collaborative-editor-skeleton",inset:0,children:(0,s.jsx)(i.M,{h:"100%",children:(0,s.jsxs)(l.K,{align:"center",children:[(0,s.jsx)(c.$,{}),eC.map((e,t)=>{let{msg:n}=e;return(0,s.jsx)(d.x,{children:n},t)})]})})}),eI&&(0,s.jsx)(D.y,{extensions:J.current,doc:t,docId:n,editorId:"main",onCreate:e=>{let{editor:t}=e;setTimeout(()=>{Y(t),o&&o(t),requestAnimationFrame(()=>{eE("Editor rendered"),_(),ek()})},10)},readOnly:ea||k||eT,shouldSupportComments:!0,shouldSupportMenus:!0,scrollingParentSelector:I})]})});var nd=n(31709),nu=n(7636)},41425:function(e,t,n){n.d(t,{bI:function(){return r}}),n(61811);let o=new URLSearchParams(window.location.search),s=o.get("SCHEMA_VERSION")?Number(o.get("SCHEMA_VERSION")):null,r=s||104}}]);
//# sourceMappingURL=9435-63f53c2a082c67da.js.map